version: '3.8'

# Production Environment: All infrastructure (PostgreSQL, Redis, Kafka) is external.
# Services connect to company internal infrastructure via environment variables.

services:
  # Workflow Engine Core - Production
  workflow-engine:
    image: ${REGISTRY:-workflow-platform}/workflow-engine:${IMAGE_TAG:-latest}
    container_name: platform-workflow-engine-prod
    ports:
      - "${WORKFLOW_ENGINE_PORT}:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      ADMIN_CENTER_URL: ${ADMIN_CENTER_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      HIKARI_MAXIMUM_POOL_SIZE: ${HIKARI_MAXIMUM_POOL_SIZE:-50}
      HIKARI_MINIMUM_IDLE: ${HIKARI_MINIMUM_IDLE:-10}
      HIKARI_CONNECTION_TIMEOUT: ${HIKARI_CONNECTION_TIMEOUT:-30000}
      JAVA_OPTS: "-Xmx2G -Xms1G -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./logs:/app/logs
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2.5G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  # Admin Center Backend - Production
  admin-center:
    image: ${REGISTRY:-workflow-platform}/admin-center:${IMAGE_TAG:-latest}
    container_name: platform-admin-center-prod
    ports:
      - "${ADMIN_CENTER_PORT}:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      HIKARI_MAXIMUM_POOL_SIZE: ${HIKARI_MAXIMUM_POOL_SIZE:-50}
      HIKARI_MINIMUM_IDLE: ${HIKARI_MINIMUM_IDLE:-10}
      HIKARI_CONNECTION_TIMEOUT: ${HIKARI_CONNECTION_TIMEOUT:-30000}
      JAVA_OPTS: "-Xmx1G -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./logs:/app/logs
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # User Portal Backend - Production
  user-portal:
    image: ${REGISTRY:-workflow-platform}/user-portal:${IMAGE_TAG:-latest}
    container_name: platform-user-portal-prod
    depends_on:
      - workflow-engine
    ports:
      - "${USER_PORTAL_PORT}:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      ADMIN_CENTER_URL: ${ADMIN_CENTER_URL}
      WORKFLOW_ENGINE_URL: ${WORKFLOW_ENGINE_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      JAVA_OPTS: "-Xmx1G -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./logs:/app/logs
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Developer Workstation Backend - Production
  developer-workstation:
    image: ${REGISTRY:-workflow-platform}/developer-workstation:${IMAGE_TAG:-latest}
    container_name: platform-developer-workstation-prod
    ports:
      - "${DEVELOPER_WORKSTATION_PORT}:8080"
    environment:
      SERVER_PORT: 8080
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      ADMIN_CENTER_URL: ${ADMIN_CENTER_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      JAVA_OPTS: "-Xmx1G -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./logs:/app/logs
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # API Gateway - Production
  api-gateway:
    image: ${REGISTRY:-workflow-platform}/api-gateway:${IMAGE_TAG:-latest}
    container_name: platform-api-gateway-prod
    ports:
      - "${API_GATEWAY_PORT}:8080"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_REDIS_HOST: ${REDIS_HOST}
      SPRING_REDIS_PORT: ${REDIS_PORT}
      SPRING_REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_SECRET_KEY: ${ENCRYPTION_SECRET_KEY}
      JAVA_OPTS: "-Xmx1G -Xms512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
    volumes:
      - ./logs:/app/logs
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Frontend - Admin Center - Production
  admin-center-frontend:
    image: ${REGISTRY:-workflow-platform}/admin-center-frontend:${IMAGE_TAG:-latest}
    container_name: platform-admin-center-frontend-prod
    depends_on:
      - admin-center
    ports:
      - "${FRONTEND_ADMIN_PORT}:80"
    environment:
      ADMIN_CENTER_BACKEND_URL: ${ADMIN_CENTER_BACKEND_URL}
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # Frontend - User Portal - Production
  user-portal-frontend:
    image: ${REGISTRY:-workflow-platform}/user-portal-frontend:${IMAGE_TAG:-latest}
    container_name: platform-user-portal-frontend-prod
    depends_on:
      - user-portal
    ports:
      - "${FRONTEND_PORTAL_PORT}:80"
    environment:
      USER_PORTAL_BACKEND_URL: ${USER_PORTAL_BACKEND_URL}
      ADMIN_CENTER_BACKEND_URL: ${ADMIN_CENTER_BACKEND_URL}
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

  # Frontend - Developer Workstation - Production
  developer-workstation-frontend:
    image: ${REGISTRY:-workflow-platform}/developer-workstation-frontend:${IMAGE_TAG:-latest}
    container_name: platform-developer-workstation-frontend-prod
    depends_on:
      - developer-workstation
    ports:
      - "${FRONTEND_DEVELOPER_PORT}:80"
    environment:
      DEVELOPER_WORKSTATION_BACKEND_URL: ${DEVELOPER_WORKSTATION_BACKEND_URL}
      ADMIN_CENTER_BACKEND_URL: ${ADMIN_CENTER_BACKEND_URL}
    networks:
      - platform-prod-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'

networks:
  platform-prod-network:
    driver: bridge
    name: platform-prod-network
