server:
  port: ${SERVER_PORT:8080}

spring:
  application:
    name: api-gateway
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  
  # Cloud Gateway Configuration
  cloud:
    gateway:
      routes:
        # Authentication routes - handled by workflow-engine for now
        - id: auth-service
          uri: ${WORKFLOW_ENGINE_URL:http://workflow-engine:8080}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=0
        # User management routes - admin-center
        - id: user-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/users/**
          filters:
            - RewritePath=/api/v1/users/(?<segment>.*), /users/${segment}
            - RewritePath=/api/v1/users, /users
        # Role management routes - admin-center
        - id: role-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/roles/**
          filters:
            - StripPrefix=0
        # Permission routes - admin-center
        - id: permission-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/permissions/**
          filters:
            - StripPrefix=0
        - id: workflow-engine
          uri: ${WORKFLOW_ENGINE_URL:http://workflow-engine:8080}
          predicates:
            - Path=/api/workflow/**
          filters:
            - StripPrefix=1
        - id: admin-center
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/admin/**
          filters:
            - StripPrefix=1
        - id: developer-workstation
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/dev/**
          filters:
            - StripPrefix=1
        # Developer Workstation - Function Units
        - id: function-units
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/function-units/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Icons
        - id: icons
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/icons/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Versions
        - id: versions
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/versions/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Export/Import
        - id: export-import
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/export/**,/api/v1/import/**
          filters:
            - StripPrefix=0
        - id: user-portal
          uri: ${USER_PORTAL_URL:http://user-portal:8080}
          predicates:
            - Path=/api/portal/**
          filters:
            - StripPrefix=1
        # User Portal - Tasks API
        - id: user-portal-tasks
          uri: ${USER_PORTAL_URL:http://user-portal:8080}
          predicates:
            - Path=/api/v1/tasks/**
          filters:
            - RewritePath=/api/v1/tasks/(?<segment>.*), /tasks/${segment}
            - RewritePath=/api/v1/tasks, /tasks
        # Admin Center - System Monitor API
        - id: admin-monitor
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/admin/monitor/**
          filters:
            - StripPrefix=0
        # Admin Center - Security Audit API
        - id: admin-security
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/admin/security/**
          filters:
            - StripPrefix=0
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: ${CORS_ALLOWED_ORIGINS:*}
            allowedMethods: "*"
            allowedHeaders: "*"

  # Redis Configuration
  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      password: ${SPRING_REDIS_PASSWORD:redis123}
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

# Rate Limiting Configuration
platform:
  gateway:
    rate-limit:
      enabled: true
      default-limit: 100
      default-duration: 60
      endpoints:
        /api/v1/auth/login: 10
        /api/v1/auth/refresh: 20
        /api/auth/login: 10
        /api/auth/register: 5
    # Public endpoints that don't require authentication
    public-paths:
      - /api/v1/auth/login
      - /api/v1/auth/refresh
      - /actuator/**
      - /swagger-ui/**
      - /v3/api-docs/**

# JWT Configuration
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-for-development-only}
  expiration: 86400000
  refresh-expiration: 604800000

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
  health:
    redis:
      enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    com.platform: DEBUG
    org.springframework.cloud.gateway: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] [%X{traceId}] %-5level %logger{36} - %msg%n"

---
# Development Profile
spring:
  config:
    activate:
      on-profile: dev

logging:
  level:
    com.platform: DEBUG

---
# Docker Profile
spring:
  config:
    activate:
      on-profile: docker

---
# Production Profile
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
    com.platform: INFO

management:
  endpoint:
    health:
      show-details: never
