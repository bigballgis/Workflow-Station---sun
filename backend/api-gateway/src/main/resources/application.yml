server:
  port: ${SERVER_PORT:8090}

spring:
  application:
    name: api-gateway
  
  # Cloud Gateway Configuration
  cloud:
    gateway:
      routes:
        # Admin Center - Auth (login/logout/refresh/me) - must be before generic auth-service
        - id: admin-center-auth
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/admin/auth/**
          filters:
            - StripPrefix=0
        # Authentication routes - workflow-engine (e.g. other clients using /api/v1/auth)
        - id: auth-service
          uri: ${WORKFLOW_ENGINE_URL:http://workflow-engine:8080}
          predicates:
            - Path=/api/v1/auth/**
          filters:
            - StripPrefix=0
        # User management routes - admin-center
        - id: user-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/users/**
          filters:
            - RewritePath=/api/v1/users/(?<segment>.*), /users/${segment}
            - RewritePath=/api/v1/users, /users
        # Role management routes - admin-center
        - id: role-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/roles/**
          filters:
            - StripPrefix=0
        # Permission routes - admin-center
        - id: permission-management
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/permissions/**
          filters:
            - StripPrefix=0
        - id: workflow-engine
          uri: ${WORKFLOW_ENGINE_URL:http://workflow-engine:8080}
          predicates:
            - Path=/api/workflow/**
          filters:
            - StripPrefix=1
        - id: admin-center
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/admin/**
          filters:
            - StripPrefix=1
        - id: developer-workstation
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/dev/**
          filters:
            - StripPrefix=1
        # Developer Workstation - Function Units
        - id: function-units
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/function-units/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Icons
        - id: icons
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/icons/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Versions
        - id: versions
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/versions/**
          filters:
            - StripPrefix=0
        # Developer Workstation - Export/Import
        - id: export-import
          uri: ${DEVELOPER_WORKSTATION_URL:http://developer-workstation:8080}
          predicates:
            - Path=/api/v1/export/**,/api/v1/import/**
          filters:
            - StripPrefix=0
        - id: user-portal
          uri: ${USER_PORTAL_URL:http://user-portal:8080}
          predicates:
            - Path=/api/portal/**
          filters:
            - StripPrefix=1
        # User Portal - Tasks API
        - id: user-portal-tasks
          uri: ${USER_PORTAL_URL:http://user-portal:8080}
          predicates:
            - Path=/api/v1/tasks/**
          filters:
            - RewritePath=/api/v1/tasks/(?<segment>.*), /tasks/${segment}
            - RewritePath=/api/v1/tasks, /tasks
        # Admin Center - System Monitor API
        - id: admin-monitor
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/admin/monitor/**
          filters:
            - StripPrefix=0
        # Admin Center - Security Audit API
        - id: admin-security
          uri: ${ADMIN_CENTER_URL:http://admin-center:8080}
          predicates:
            - Path=/api/v1/admin/security/**
          filters:
            - StripPrefix=0
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods: "*"
            allowedHeaders: "*"

  # Redis Configuration
  data:
    redis:
      host: ${SPRING_REDIS_HOST:localhost}
      port: ${SPRING_REDIS_PORT:6379}
      password: ${SPRING_REDIS_PASSWORD:redis123}
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

# JWT Configuration
jwt:
  secret: ${JWT_SECRET_KEY:workflow-engine-jwt-secret-key-2026}
  expiration: 86400000
  refresh-expiration: 604800000

# Platform Configuration
platform:
  gateway:
    rate-limit:
      enabled: true
      default-limit: 100
      default-duration: 60
      endpoints:
        /api/v1/auth/login: 10
        /api/v1/auth/refresh: 20
        /api/v1/admin/auth/login: 10
        /api/v1/admin/auth/refresh: 20
        /api/auth/login: 10
        /api/auth/register: 5
    # Public endpoints that don't require authentication
    public-paths:
      - /api/v1/auth/login
      - /api/v1/auth/refresh
      - /api/v1/admin/auth/login
      - /api/v1/admin/auth/refresh
      - /actuator/**
      - /swagger-ui/**
      - /v3/api-docs/**
  encryption:
    secret-key: ${ENCRYPTION_KEY:workflow-aes-256-encryption-key!}

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
  health:
    redis:
      enabled: true

# Logging Configuration
logging:
  level:
    root: INFO
    com.platform: DEBUG
    org.springframework.cloud.gateway: DEBUG
  file:
    name: logs/api-gateway.log
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [api-gateway] [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [api-gateway] [%thread] %-5level %logger{36} - %msg%n"
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

# OpenAPI Configuration
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
