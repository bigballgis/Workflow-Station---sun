# =====================================================
# å¯åŠ¨åç«¯æœåŠ¡è„šæœ¬ï¼ˆDocker æ¨¡å¼ï¼‰
# =====================================================

param(
    [switch]$NoBuild       # Skip build, use existing images
)

$ErrorActionPreference = "Stop"

$BASE_DIR = $PSScriptRoot
$networkName = "platform-network"

# Set environment variables
$env:POSTGRES_PASSWORD = "platform123"
$env:REDIS_PASSWORD = "redis123"
$env:JWT_SECRET = "your-256-bit-secret-key-for-development-only"
$env:ENCRYPTION_SECRET_KEY = "your-32-byte-aes-256-secret-key!!"

Write-Host "ğŸš€ å¯åŠ¨åç«¯æœåŠ¡ï¼ˆDocker æ¨¡å¼ï¼‰..." -ForegroundColor Cyan
Write-Host ""

# Check if Docker is running
$dockerRunning = docker info 2>&1
if ($LASTEXITCODE -ne 0) {
    Write-Host "âŒ é”™è¯¯: Docker æœªè¿è¡Œï¼Œè¯·å…ˆå¯åŠ¨ Docker Desktop" -ForegroundColor Red
    exit 1
}

# Function to create network if it doesn't exist
function Ensure-Network {
    $networkExists = docker network ls --filter "name=$networkName" --format "{{.Name}}"
    if (-not $networkExists) {
        Write-Host "åˆ›å»º Docker ç½‘ç»œ: $networkName..." -ForegroundColor Yellow
        docker network create $networkName
        if ($LASTEXITCODE -ne 0) {
            Write-Host "âŒ é”™è¯¯: åˆ›å»ºç½‘ç»œå¤±è´¥" -ForegroundColor Red
            exit 1
        }
    }
}

# Function to build Docker image
function Build-Image {
    param(
        [string]$Context,
        [string]$Dockerfile,
        [string]$ImageName
    )
    
    Write-Host "æ„å»ºé•œåƒ: $ImageName..." -ForegroundColor Yellow
    docker build --platform linux/amd64 -f $Dockerfile -t $ImageName $Context
    if ($LASTEXITCODE -ne 0) {
        Write-Host "âŒ é”™è¯¯: æ„å»ºé•œåƒ $ImageName å¤±è´¥" -ForegroundColor Red
        exit 1
    }
    Write-Host "âœ… é•œåƒ $ImageName æ„å»ºæˆåŠŸ" -ForegroundColor Green
}

# Function to check if container exists
function Container-Exists {
    param([string]$ContainerName)
    $exists = docker ps -a --filter "name=$ContainerName" --format "{{.Names}}"
    return ($exists -eq $ContainerName)
}

# Function to remove container if exists
function Remove-Container {
    param([string]$ContainerName)
    if (Container-Exists $ContainerName) {
        Write-Host "ç§»é™¤å·²å­˜åœ¨çš„å®¹å™¨: $ContainerName..." -ForegroundColor Yellow
        docker rm -f $ContainerName | Out-Null
    }
}

# Function to wait for service to be healthy
function Wait-ForService {
    param(
        [string]$ContainerName,
        [string]$CheckCommand,
        [int]$MaxRetries = 30,
        [int]$RetryInterval = 2
    )
    
    Write-Host "ç­‰å¾… $ContainerName å°±ç»ª..." -ForegroundColor Gray
    $retryCount = 0
    while ($retryCount -lt $MaxRetries) {
        $result = docker exec $ContainerName $CheckCommand 2>&1
        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… $ContainerName å·²å°±ç»ª" -ForegroundColor Green
            return $true
        }
        $retryCount++
        Write-Host "ç­‰å¾… $ContainerName... ($retryCount/$MaxRetries)" -ForegroundColor Gray
        Start-Sleep -Seconds $RetryInterval
    }
    Write-Host "âŒ é”™è¯¯: $ContainerName å¯åŠ¨å¤±è´¥" -ForegroundColor Red
    return $false
}

# Create network
Ensure-Network

# Function to check and start infrastructure service
function Ensure-InfrastructureService {
    param(
        [string]$ContainerName,
        [string]$ServiceName,
        [string]$CheckCommand,
        [scriptblock]$StartScript
    )
    
    Write-Host "æ£€æŸ¥ $ServiceName æœåŠ¡..." -ForegroundColor Yellow
    $exists = Container-Exists $ContainerName
    if (-not $exists) {
        Write-Host "âš ï¸  è­¦å‘Š: $ServiceName æœªè¿è¡Œï¼Œæ­£åœ¨å¯åŠ¨..." -ForegroundColor Yellow
        & $StartScript
        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… $ServiceName å·²å¯åŠ¨" -ForegroundColor Green
            if ($CheckCommand) {
                Wait-ForService $ContainerName $CheckCommand
            }
        } else {
            Write-Host "âŒ é”™è¯¯: å¯åŠ¨ $ServiceName å¤±è´¥" -ForegroundColor Red
            exit 1
        }
    } else {
        $running = docker ps --filter "name=$ContainerName" --format "{{.Names}}"
        if ($running -eq $ContainerName) {
            Write-Host "âœ… $ServiceName æ­£åœ¨è¿è¡Œ" -ForegroundColor Green
        } else {
            Write-Host "å¯åŠ¨ $ServiceName å®¹å™¨..." -ForegroundColor Yellow
            docker start $ContainerName
            if ($CheckCommand) {
                Wait-ForService $ContainerName $CheckCommand
            }
        }
    }
}

# Check and start PostgreSQL
Ensure-InfrastructureService "platform-postgres" "PostgreSQL" "pg_isready -U platform -d workflow_platform" {
    Remove-Container "platform-postgres"
    docker run -d `
        --name platform-postgres `
        --network $networkName `
        --network-alias postgres `
        -e POSTGRES_DB=workflow_platform `
        -e POSTGRES_USER=platform `
        -e POSTGRES_PASSWORD=$env:POSTGRES_PASSWORD `
        -p 5432:5432 `
        -v postgres_data:/var/lib/postgresql/data `
        -v "${PWD}/deploy/init-scripts/00-schema/01-schema.sql:/docker-entrypoint-initdb.d/00-01-schema.sql" `
        -v "${PWD}/deploy/init-scripts/01-admin/01-admin-user.sql:/docker-entrypoint-initdb.d/01-01-admin-user.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/01-organization.sql:/docker-entrypoint-initdb.d/02-01-organization.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/02-organization-detail.sql:/docker-entrypoint-initdb.d/02-02-organization-detail.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/03-users.sql:/docker-entrypoint-initdb.d/02-03-users.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/04-role-assignments.sql:/docker-entrypoint-initdb.d/02-04-role-assignments.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/04-department-managers.sql:/docker-entrypoint-initdb.d/02-05-department-managers.sql" `
        -v "${PWD}/deploy/init-scripts/02-test-data/05-virtual-groups.sql:/docker-entrypoint-initdb.d/02-06-virtual-groups.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-01-function-unit.sql:/docker-entrypoint-initdb.d/04-01-function-unit.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-02-tables.sql:/docker-entrypoint-initdb.d/04-02-tables.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-03-fields-main-fixed.sql:/docker-entrypoint-initdb.d/04-03-fields-main-fixed.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-04-fields-sub-fixed.sql:/docker-entrypoint-initdb.d/04-04-fields-sub-fixed.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-05-fk-relations.sql:/docker-entrypoint-initdb.d/04-05-fk-relations.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-06-forms-fixed.sql:/docker-entrypoint-initdb.d/04-06-forms-fixed.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-07-actions-fixed.sql:/docker-entrypoint-initdb.d/04-07-actions-fixed.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-08-process-fixed-v2-corrected.sql:/docker-entrypoint-initdb.d/04-08-process-fixed-v2-corrected.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-09-form-bindings-fixed.sql:/docker-entrypoint-initdb.d/04-09-form-bindings-fixed.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-10-form-configs.sql:/docker-entrypoint-initdb.d/04-10-form-configs.sql" `
        -v "${PWD}/deploy/init-scripts/04-purchase-workflow/04-11-action-configs.sql:/docker-entrypoint-initdb.d/04-11-action-configs.sql" `
        --restart unless-stopped `
        postgres:16.5-alpine
}

# Check and start Redis
Ensure-InfrastructureService "platform-redis" "Redis" "redis-cli -a $env:REDIS_PASSWORD ping" {
    Remove-Container "platform-redis"
    docker run -d `
        --name platform-redis `
        --network $networkName `
        --network-alias redis `
        -p 6379:6379 `
        -v redis_data:/data `
        --restart unless-stopped `
        redis:7.2-alpine redis-server --appendonly yes --requirepass $env:REDIS_PASSWORD
}

# Check and start Zookeeper (required for Kafka)
Ensure-InfrastructureService "platform-zookeeper" "Zookeeper" $null {
    Remove-Container "platform-zookeeper"
    docker run -d `
        --name platform-zookeeper `
        --network $networkName `
        -e ZOOKEEPER_CLIENT_PORT=2181 `
        -e ZOOKEEPER_TICK_TIME=2000 `
        -p 2181:2181 `
        -v zookeeper_data:/var/lib/zookeeper/data `
        -v zookeeper_log:/var/lib/zookeeper/log `
        --restart unless-stopped `
        confluentinc/cp-zookeeper:7.5.3
}

# Check and start Kafka
Ensure-InfrastructureService "platform-kafka" "Kafka" $null {
    Remove-Container "platform-kafka"
    docker run -d `
        --name platform-kafka `
        --network $networkName `
        --network-alias kafka `
        -e KAFKA_BROKER_ID=1 `
        -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 `
        -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092 `
        -e KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT `
        -e KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT `
        -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 `
        -e KAFKA_AUTO_CREATE_TOPICS_ENABLE=true `
        -p 9092:9092 `
        -p 29092:29092 `
        -v kafka_data:/var/lib/kafka/data `
        --restart unless-stopped `
        confluentinc/cp-kafka:7.5.3
}

# Step 1: Build platform modules (if needed)
if (-not $NoBuild) {
    Write-Host ""
    Write-Host "æ­¥éª¤ 1: æ„å»º platform æ¨¡å—..." -ForegroundColor Yellow
    Write-Host "è¿è¡Œ Maven æ„å»ºï¼ˆè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰..." -ForegroundColor Gray
    mvn clean install -DskipTests
    if ($LASTEXITCODE -ne 0) {
        Write-Host "âŒ é”™è¯¯: Maven æ„å»ºå¤±è´¥" -ForegroundColor Red
        exit 1
    }
    Write-Host "âœ… Platform æ¨¡å—æ„å»ºæˆåŠŸ" -ForegroundColor Green
}

# Step 2: Build backend services
Write-Host ""
Write-Host "æ­¥éª¤ 2: æ„å»ºåç«¯æœåŠ¡..." -ForegroundColor Yellow

if (-not $NoBuild) {
    Write-Host "æ‰“åŒ…åç«¯ JAR æ–‡ä»¶..." -ForegroundColor Gray
    mvn clean package -DskipTests -pl backend/workflow-engine-core,backend/admin-center,backend/user-portal,backend/developer-workstation,backend/api-gateway -am
    if ($LASTEXITCODE -ne 0) {
        Write-Host "âŒ é”™è¯¯: åç«¯æ„å»ºå¤±è´¥" -ForegroundColor Red
        exit 1
    }
}

# Build Docker images
Write-Host "æ„å»ºåç«¯ Docker é•œåƒ..." -ForegroundColor Yellow

Build-Image "./backend/workflow-engine-core" "./backend/workflow-engine-core/Dockerfile" "workflow-engine:latest"
Build-Image "./backend/admin-center" "./backend/admin-center/Dockerfile" "admin-center:latest"
Build-Image "./backend/user-portal" "./backend/user-portal/Dockerfile" "user-portal:latest"
Build-Image "./backend/developer-workstation" "./backend/developer-workstation/Dockerfile" "developer-workstation:latest"
Build-Image "./backend/api-gateway" "./backend/api-gateway/Dockerfile" "api-gateway:latest"

# Step 3: Start backend services
Write-Host ""
Write-Host "æ­¥éª¤ 3: å¯åŠ¨åç«¯æœåŠ¡..." -ForegroundColor Yellow

# Start Workflow Engine
Remove-Container "platform-workflow-engine"
Write-Host "å¯åŠ¨ Workflow Engine (ç«¯å£ 8081)..." -ForegroundColor Yellow
docker run -d `
    --name platform-workflow-engine `
    --network $networkName `
    -e SERVER_PORT=8080 `
    -e SPRING_PROFILES_ACTIVE=docker `
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/workflow_platform `
    -e SPRING_DATASOURCE_USERNAME=platform `
    -e SPRING_DATASOURCE_PASSWORD=$env:POSTGRES_PASSWORD `
    -e SPRING_REDIS_HOST=redis `
    -e SPRING_REDIS_PORT=6379 `
    -e SPRING_REDIS_PASSWORD=$env:REDIS_PASSWORD `
    -e SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092 `
    -e ADMIN_CENTER_URL=http://admin-center:8080 `
    -e JWT_SECRET=$env:JWT_SECRET `
    -e ENCRYPTION_SECRET_KEY=$env:ENCRYPTION_SECRET_KEY `
    -p 8081:8080 `
    --restart unless-stopped `
    workflow-engine:latest

# Start Admin Center
Remove-Container "platform-admin-center"
Write-Host "å¯åŠ¨ Admin Center (ç«¯å£ 8090)..." -ForegroundColor Yellow
docker run -d `
    --name platform-admin-center `
    --network $networkName `
    -e SERVER_PORT=8080 `
    -e SPRING_PROFILES_ACTIVE=docker `
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/workflow_platform `
    -e SPRING_DATASOURCE_USERNAME=platform `
    -e SPRING_DATASOURCE_PASSWORD=$env:POSTGRES_PASSWORD `
    -e SPRING_REDIS_HOST=redis `
    -e SPRING_REDIS_PORT=6379 `
    -e SPRING_REDIS_PASSWORD=$env:REDIS_PASSWORD `
    -e SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:29092 `
    -e JWT_SECRET=$env:JWT_SECRET `
    -e ENCRYPTION_SECRET_KEY=$env:ENCRYPTION_SECRET_KEY `
    -p 8090:8080 `
    --restart unless-stopped `
    admin-center:latest

# Start User Portal
Remove-Container "platform-user-portal"
Write-Host "å¯åŠ¨ User Portal (ç«¯å£ 8082)..." -ForegroundColor Yellow
docker run -d `
    --name platform-user-portal `
    --network $networkName `
    -e SERVER_PORT=8080 `
    -e SPRING_PROFILES_ACTIVE=docker `
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/workflow_platform `
    -e SPRING_DATASOURCE_USERNAME=platform `
    -e SPRING_DATASOURCE_PASSWORD=$env:POSTGRES_PASSWORD `
    -e SPRING_REDIS_HOST=redis `
    -e SPRING_REDIS_PORT=6379 `
    -e SPRING_REDIS_PASSWORD=$env:REDIS_PASSWORD `
    -e ADMIN_CENTER_URL=http://admin-center:8080 `
    -e WORKFLOW_ENGINE_URL=http://workflow-engine:8080 `
    -e JWT_SECRET=$env:JWT_SECRET `
    -e ENCRYPTION_SECRET_KEY=$env:ENCRYPTION_SECRET_KEY `
    -p 8082:8080 `
    --restart unless-stopped `
    user-portal:latest

# Start Developer Workstation
Remove-Container "platform-developer-workstation"
Write-Host "å¯åŠ¨ Developer Workstation (ç«¯å£ 8083)..." -ForegroundColor Yellow
docker run -d `
    --name platform-developer-workstation `
    --network $networkName `
    -e SERVER_PORT=8080 `
    -e SPRING_PROFILES_ACTIVE=docker `
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/workflow_platform `
    -e SPRING_DATASOURCE_USERNAME=platform `
    -e SPRING_DATASOURCE_PASSWORD=$env:POSTGRES_PASSWORD `
    -e SPRING_REDIS_HOST=redis `
    -e SPRING_REDIS_PORT=6379 `
    -e SPRING_REDIS_PASSWORD=$env:REDIS_PASSWORD `
    -e ADMIN_CENTER_URL=http://admin-center:8080 `
    -e JWT_SECRET=$env:JWT_SECRET `
    -e ENCRYPTION_SECRET_KEY=$env:ENCRYPTION_SECRET_KEY `
    -p 8083:8080 `
    --restart unless-stopped `
    developer-workstation:latest

# Start API Gateway
Remove-Container "platform-api-gateway"
Write-Host "å¯åŠ¨ API Gateway (ç«¯å£ 8080)..." -ForegroundColor Yellow
docker run -d `
    --name platform-api-gateway `
    --network $networkName `
    -e SPRING_PROFILES_ACTIVE=docker `
    -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/workflow_platform `
    -e SPRING_DATASOURCE_USERNAME=platform `
    -e SPRING_DATASOURCE_PASSWORD=$env:POSTGRES_PASSWORD `
    -e SPRING_REDIS_HOST=redis `
    -e SPRING_REDIS_PORT=6379 `
    -e SPRING_REDIS_PASSWORD=$env:REDIS_PASSWORD `
    -e WORKFLOW_ENGINE_URL=http://workflow-engine:8080 `
    -e ADMIN_CENTER_URL=http://admin-center:8080 `
    -e USER_PORTAL_URL=http://user-portal:8080 `
    -e DEVELOPER_WORKSTATION_URL=http://developer-workstation:8080 `
    -e JWT_SECRET=$env:JWT_SECRET `
    -p 8080:8080 `
    --restart unless-stopped `
    api-gateway:latest

Write-Host ""
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "âœ… æ‰€æœ‰åç«¯æœåŠ¡å·²å¯åŠ¨ï¼" -ForegroundColor Green
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "æœåŠ¡è®¿é—®åœ°å€ï¼š" -ForegroundColor Cyan
Write-Host "  - API Gateway:        http://localhost:8080" -ForegroundColor White
Write-Host "  - Workflow Engine:    http://localhost:8081" -ForegroundColor White
Write-Host "  - User Portal:        http://localhost:8082" -ForegroundColor White
Write-Host "  - Developer WS:       http://localhost:8083" -ForegroundColor White
Write-Host "  - Admin Center:       http://localhost:8090" -ForegroundColor White
Write-Host ""
Write-Host "æŸ¥çœ‹æ—¥å¿—ï¼š" -ForegroundColor Cyan
Write-Host "  docker logs -f platform-api-gateway" -ForegroundColor Gray
Write-Host "  docker logs -f platform-workflow-engine" -ForegroundColor Gray
Write-Host "  docker logs -f platform-admin-center" -ForegroundColor Gray
Write-Host ""
Write-Host "åœæ­¢æœåŠ¡ï¼š" -ForegroundColor Cyan
Write-Host "  docker stop platform-api-gateway platform-workflow-engine platform-admin-center platform-user-portal platform-developer-workstation" -ForegroundColor Gray
Write-Host ""
