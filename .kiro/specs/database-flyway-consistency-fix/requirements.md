# Database-Flyway Consistency Fix - Requirements

## 1. Overview

**Goal**: Fix inconsistencies between Flyway migration scripts and actual database usage, using the current code as the source of truth.

**Scope**: 
- Fix CHECK constraints to match code usage
- Clean up duplicate indexes
- Update Flyway migration files to reflect actual requirements
- Ensure new deployments work correctly

## 2. Problem Analysis

### 2.1 UserStatus Enum Mismatch

**Current Situation**:
- **Code (admin-center)**: Uses `com.admin.enums.UserStatus` with 4 values: `ACTIVE`, `DISABLED`, `LOCKED`, `PENDING`
- **Code (platform-security)**: Uses `com.platform.security.model.UserStatus` with 3 values: `ACTIVE`, `INACTIVE`, `LOCKED`
- **Database**: CHECK constraint only allows 3 values: `ACTIVE`, `INACTIVE`, `LOCKED`
- **Flyway V1**: Defines 5 values: `ACTIVE`, `INACTIVE`, `DISABLED`, `LOCKED`, `PENDING`

**Root Cause**: 
- Two different UserStatus enums exist in the codebase
- admin-center module is the primary user management module and uses DISABLED/PENDING
- Database constraint doesn't match admin-center's requirements

**Impact**:
- Admin-center code cannot set user status to DISABLED or PENDING (will fail with constraint violation)
- Status transition logic in `UserManagerComponent.validateStatusTransition()` references DISABLED and PENDING but cannot use them

### 2.2 Duplicate Indexes

**Current Situation**:
- `sys_users` table has duplicate indexes:
  - `idx_sys_users_username` and `idx_user_username` (both on username column)
  - `idx_sys_users_email` and `idx_user_email` (both on email column)
  - `idx_sys_users_status` and `idx_user_status` (both on status column)

**Root Cause**: 
- Flyway script defines indexes with `idx_sys_users_*` prefix
- JPA Entity annotations define indexes with `idx_user_*` prefix
- Both sets of indexes get created

**Impact**:
- Wastes storage space
- Slightly impacts write performance
- Confusing for database maintenance

### 2.3 sys_departments Table

**Status**: ✅ Already cleaned up (2026-01-22)
- Table removed from database
- No code references exist
- No action needed

## 3. Acceptance Criteria

### 3.1 UserStatus CHECK Constraint Fix

**AC 3.1.1**: Database CHECK constraint must allow all 4 status values used by admin-center
- ✅ ACTIVE
- ✅ DISABLED (currently missing)
- ✅ LOCKED
- ✅ PENDING (currently missing)

**AC 3.1.2**: Flyway V1 migration script must define the correct CHECK constraint
- Must match the values used by `com.admin.enums.UserStatus`
- Must be consistent with admin-center code usage

**AC 3.1.3**: Status transitions must work correctly
- User can be set to DISABLED status without constraint violation
- User can be set to PENDING status without constraint violation
- All status transitions in `UserManagerComponent.validateStatusTransition()` must be valid

**AC 3.1.4**: INACTIVE status handling
- Document that INACTIVE is not used by admin-center
- Consider if INACTIVE should be removed from Flyway or kept for backward compatibility

### 3.2 Duplicate Index Cleanup

**AC 3.2.1**: Remove duplicate indexes from database
- Keep `idx_sys_users_*` series (defined in Flyway)
- Remove `idx_user_*` series (auto-generated by JPA)

**AC 3.2.2**: Update JPA Entity to prevent duplicate index creation
- Remove `@Index` annotations from `platform-security` User entity
- Or rename indexes in Entity to match Flyway definitions

**AC 3.2.3**: Verify index cleanup
- Query `pg_indexes` to confirm only one index per column
- Ensure query performance is not affected

### 3.3 Flyway Migration File Updates

**AC 3.3.1**: Update `backend/platform-security/src/main/resources/db/migration/V1__init_schema.sql`
- Fix sys_users CHECK constraint to include DISABLED and PENDING
- Document the decision about INACTIVE status

**AC 3.3.2**: Create migration script for existing databases
- Create `V2__fix_user_status_constraint.sql` to update existing databases
- Script must be idempotent (safe to run multiple times)

**AC 3.3.3**: Update index definitions
- Ensure Flyway script creates indexes with consistent naming
- Remove or update conflicting index definitions

### 3.4 Testing and Validation

**AC 3.4.1**: Test on fresh database deployment
- Drop and recreate test database
- Run Flyway migrations
- Verify all constraints and indexes are correct

**AC 3.4.2**: Test on existing database
- Run V2 migration on existing database
- Verify constraint is updated correctly
- Verify no data loss or corruption

**AC 3.4.3**: Test admin-center functionality
- Create user with DISABLED status
- Create user with PENDING status
- Verify status transitions work correctly
- Verify no constraint violations occur

## 4. Non-Functional Requirements

### 4.1 Backward Compatibility
- Migration scripts must not break existing data
- Existing users with INACTIVE status (if any) should remain valid
- No downtime required for migration

### 4.2 Documentation
- Document the decision about UserStatus enum values
- Update development guidelines with the correct status values
- Add comments in Flyway scripts explaining the constraint values

### 4.3 Code Consistency
- Resolve the dual UserStatus enum situation
- Document which modules use which enum
- Consider consolidating to a single UserStatus enum in future

## 5. Out of Scope

- Consolidating the two UserStatus enums (future enhancement)
- Migrating existing INACTIVE users to DISABLED (if any exist)
- Cleaning up other minor inconsistencies not affecting functionality
- Updating dw_form_table_bindings duplicate constraint (low priority)

## 6. Dependencies

- Access to PostgreSQL database
- Ability to run Flyway migrations
- Ability to restart backend services for testing

## 7. Risks and Mitigation

### Risk 7.1: Data Loss During Constraint Update
**Mitigation**: 
- Test migration on copy of production data first
- Verify no users have invalid status values before migration
- Use transaction to allow rollback if needed

### Risk 7.2: Breaking Existing Code
**Mitigation**:
- Review all code using UserStatus enum
- Test all status-related functionality after migration
- Have rollback plan ready

### Risk 7.3: Index Removal Affects Performance
**Mitigation**:
- Verify query plans before and after index removal
- Keep one index per column (the Flyway-defined ones)
- Monitor query performance after deployment

## 8. Success Metrics

- ✅ All 4 status values (ACTIVE, DISABLED, LOCKED, PENDING) can be used without errors
- ✅ No duplicate indexes exist on sys_users table
- ✅ Fresh database deployment creates correct schema
- ✅ Existing database can be migrated without errors
- ✅ All admin-center user management tests pass
- ✅ No constraint violations in application logs

## 9. Implementation Notes

### 9.1 Recommended Approach

**Option A: Update to 4 Status Values (Recommended)**
- Update database CHECK constraint to allow: ACTIVE, DISABLED, LOCKED, PENDING
- Update Flyway V1 to define these 4 values
- Remove INACTIVE from Flyway (not used by admin-center)
- Document that platform-security module uses different enum (3 values)

**Option B: Keep 5 Status Values**
- Keep all 5 values in database: ACTIVE, INACTIVE, DISABLED, LOCKED, PENDING
- Update Flyway V1 to define all 5 values
- Document that INACTIVE is legacy/unused

**Recommendation**: Choose Option A for simplicity and clarity

### 9.2 Migration Strategy

1. **Phase 1**: Update Flyway V1 script (for new deployments)
2. **Phase 2**: Create V2 migration script (for existing databases)
3. **Phase 3**: Clean up duplicate indexes
4. **Phase 4**: Test and validate
5. **Phase 5**: Update documentation

## 10. Related Documents

- Database-Flyway Consistency Report: `docs/database-flyway-consistency-report.md`
- Development Guidelines: `.kiro/steering/development-guidelines.md`
- User Entity: `backend/admin-center/src/main/java/com/admin/entity/User.java`
- UserStatus Enums:
  - `backend/admin-center/src/main/java/com/admin/enums/UserStatus.java`
  - `backend/platform-security/src/main/java/com/platform/security/model/UserStatus.java`
